# K3s AWS Deployment

This project deploys a minimal K3s Kubernetes cluster on AWS using free tier resources. The deployment is automated using Terraform for infrastructure provisioning and Ansible for configuration management.

## Project Structure

```
K3s_AWS_Deployment/
├── ansible/
│   ├── ansible.cfg         # Ansible configuration
│   ├── inventory.ini       # Inventory file (auto-generated by Terraform)
│   ├── k3s-install.yml     # Playbook to install K3s
│   └── k3s-app-deploy.yml  # Playbook to deploy a sample application
├── bin/
│   ├── deploy.sh           # Script to deploy the entire stack
│   └── destroy.sh          # Script to destroy all resources
├── terraform/
│   ├── main.tf             # Main Terraform configuration
│   ├── variables.tf        # Variable definitions
│   ├── outputs.tf          # Output definitions
│   └── versions.tf         # Terraform and provider versions
├── aws-login.sh            # Script to set AWS credentials (not in repository)
└── README.md               # This file
```

## Prerequisites

- AWS Account (Free Tier eligible)
- AWS CLI installed and configured
- Terraform installed (version >= 1.0.0)
- Ansible installed (version >= 2.9)
- SSH key pair (will be created automatically if not present)

## Deployment Steps

### 1. Setup AWS Credentials

Create an `aws-login.sh` file with your AWS credentials:

```bash
#!/bin/bash
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"
export AWS_DEFAULT_REGION="us-east-1"
```

### 2. Customize Variables (Optional)

Modify the variables in `terraform/variables.tf` to customize your deployment.

### 3. Deploy the Stack

Run the deployment script:

```bash
cd bin
./deploy.sh
```

The script will:
- Import your SSH key to AWS
- Create the necessary AWS infrastructure using Terraform
- Install K3s on the EC2 instance using Ansible
- Deploy a sample application to K3s
- Save the kubeconfig file to `bin/kubeconfig`

### 4. Access the Application

Once deployed, you can access the sample application at:

```
http://<server-ip>:30080
```

The server IP will be displayed at the end of the deployment.

### 5. Connect to the Cluster

To use kubectl with the cluster:

```bash
export KUBECONFIG=$(pwd)/../bin/kubeconfig
kubectl get nodes
```

### 6. Clean Up

To destroy all resources and avoid AWS charges:

```bash
cd bin
./destroy.sh
```

## Components

### Infrastructure (Terraform)

- VPC with public subnet
- Internet gateway and route table
- Security group with required ports
- t2.micro EC2 instance (Free Tier eligible)

### K3s Installation (Ansible)

- Single-node K3s installation
- Configuration of kubeconfig for remote access

### Sample Application

- Deployment of a hello-world application
- Custom namespace creation
- NodePort service for external access

## Customization

- **Instance Type**: Change `instance_type` in `variables.tf` (default: t2.micro)
- **Region**: Change `aws_region` in `variables.tf` (default: us-east-1)
- **K3s Version**: Change `k3s_version` in both `variables.tf` and `ansible/k3s-install.yml`
- **Application**: Modify `ansible/k3s-app-deploy.yml` to deploy a different application

## Security Considerations

- The default configuration allows SSH access from anywhere (0.0.0.0/0)
- For better security, update the `my_ip` variable with your specific IP address in CIDR notation
- Consider enabling the S3 backend for Terraform state storage with encryption